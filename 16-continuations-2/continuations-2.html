<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Continuations 2 - Programming Languages I</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Lecture notes for the Programming Languages I lecture at the University of TÃ¼bingen">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../preface.html">Preface</a></li><li class="chapter-item expanded affix "><li class="part-title">Introduction</li><li class="chapter-item expanded "><a href="../01-intro/intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../02-scala-basics/scala-basics.html"><strong aria-hidden="true">2.</strong> Scala Basics</a></li><li class="chapter-item expanded affix "><li class="part-title">Arithmetic Expressions</li><li class="chapter-item expanded "><a href="../03-arithmetic-expressions/arithmetic-expressions.html"><strong aria-hidden="true">3.</strong> Arithmetic Expressions (AE)</a></li><li class="chapter-item expanded "><a href="../04-desugaring/desugaring.html"><strong aria-hidden="true">4.</strong> Desugaring</a></li><li class="chapter-item expanded "><a href="../05-name-binding/name-binding.html"><strong aria-hidden="true">5.</strong> Name Binding (WAE)</a></li><li class="chapter-item expanded "><a href="../06-first-order-functions/first-order-functions.html"><strong aria-hidden="true">6.</strong> First Order Functions (F1WAE)</a></li><li class="chapter-item expanded "><a href="../07-higher-order-functions/higher-order-functions.html"><strong aria-hidden="true">7.</strong> Higher Order Functions (FAE)</a></li><li class="chapter-item expanded "><a href="../08-lazy-evaluation/lazy-evaluation.html"><strong aria-hidden="true">8.</strong> Lazy Evaluation (LCFAE)</a></li><li class="chapter-item expanded "><a href="../09-recursive-functions/recursive-functions.html"><strong aria-hidden="true">9.</strong> Recursive Functions (RCFAE)</a></li><li class="chapter-item expanded "><a href="../10-mutation/mutation.html"><strong aria-hidden="true">10.</strong> Mutation (BCFAE)</a></li><li class="chapter-item expanded affix "><li class="part-title">Advanced Topics 1</li><li class="chapter-item expanded "><a href="../11-garbage-collection/garbage-collection.html"><strong aria-hidden="true">11.</strong> Garbage Collection</a></li><li class="chapter-item expanded "><a href="../12-meta-interpretation/meta-interpretation.html"><strong aria-hidden="true">12.</strong> Syntactic and Meta Interpretation</a></li><li class="chapter-item expanded "><a href="../13-church-encoding/church-encoding.html"><strong aria-hidden="true">13.</strong> Church Encodings</a></li><li class="chapter-item expanded "><a href="../14-object-algebras/object-algebras.html"><strong aria-hidden="true">14.</strong> Object Algebras</a></li><li class="chapter-item expanded affix "><li class="part-title">Continuations</li><li class="chapter-item expanded "><a href="../15-continuations-1/continuations-1.html"><strong aria-hidden="true">15.</strong> Continuations 1</a></li><li class="chapter-item expanded "><a href="../16-continuations-2/continuations-2.html" class="active"><strong aria-hidden="true">16.</strong> Continuations 2</a></li><li class="chapter-item expanded "><a href="../17-first-class-continuations/first-class-continuations.html"><strong aria-hidden="true">17.</strong> First Class Continuations</a></li><li class="chapter-item expanded "><a href="../18-letcc/letcc.html"><strong aria-hidden="true">18.</strong> LetCC</a></li><li class="chapter-item expanded "><a href="../19-shift-reset/shift-reset.html"><strong aria-hidden="true">19.</strong> ShiftReset</a></li><li class="chapter-item expanded affix "><li class="part-title">Monads</li><li class="chapter-item expanded "><a href="../20-monads-intro/monads-intro.html"><strong aria-hidden="true">20.</strong> Monads Intro</a></li><li class="chapter-item expanded "><a href="../21-io-monad/io-monad.html"><strong aria-hidden="true">21.</strong> IO Monad</a></li><li class="chapter-item expanded affix "><li class="part-title">Advanced Topics 2</li><li class="chapter-item expanded "><a href="../22-modular-interpreters/modular-interpreters.html"><strong aria-hidden="true">22.</strong> Modular Interpreters</a></li><li class="chapter-item expanded "><a href="../23-monadic-reflection/monadic-reflection.html"><strong aria-hidden="true">23.</strong> Monadic Reflection</a></li><li class="chapter-item expanded "><a href="../24-defunctionalization/defunctionalization.html"><strong aria-hidden="true">24.</strong> Defunctionalization</a></li><li class="chapter-item expanded affix "><li class="part-title">Type Systems</li><li class="chapter-item expanded "><a href="../25-type-systems/type-systems.html"><strong aria-hidden="true">25.</strong> Type Systems</a></li><li class="chapter-item expanded "><a href="../26-stlc/stlc.html"><strong aria-hidden="true">26.</strong> Simply Typed Lambda Calculus (STLC)</a></li><li class="chapter-item expanded "><a href="../27-type-inference/type-inference.html"><strong aria-hidden="true">27.</strong> Type Inference</a></li><li class="chapter-item expanded affix "><a href="../furtherreading.html">Further Reading</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Programming Languages I</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/ps-tuebingen-courses/pl1-lecture-notes" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/ps-tuebingen-courses/pl1-lecture-notes/blob/master/out/16-continuations-2/continuations-2.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="continuations-2"><a class="header" href="#continuations-2">Continuations 2</a></h1>
<p>The content of this chapter is available as a scala file <a href="./continuations-2.scala">here.</a></p>
<pre><code class="language-scala">import scala.language.implicitConversions

/* Today's goal is to make the &quot;web&quot; (or rather, CPS) transformation which we applied informally
  in the previous lecture formal.
  In the previous lecture we have seen that we had to translate the following program:
  println(&quot;The sum is: &quot;+ (inputNumber(&quot;First number:&quot; ) + inputNumber(&quot;Second number&quot;)))
  into this program:
  webread_k(&quot;First number&quot;, (n) =&gt;
             webread_k(&quot;Second number:&quot;, (m) =&gt; webdisplay(&quot;The sum is: &quot;+(n+m))))
  This hand-translation is sufficient if this expression is the entire program.
  If we wish to use it as a sub-expression in a larger program, this does not suffice,
  because there may be a pending computation outside its own evaluation. For that
  reason, the program has to send its result to a continuation instead of returning it:
  k =&gt; webread_k(&quot;First number&quot;, (n) =&gt;
             webread_k(&quot;Second number:&quot;, (m) =&gt; webdisplay(&quot;The sum is: &quot;+k(n+m))))
  This version can be employed in the transformation of a larger program. In the special
  case where this is the entire program we can apply the transformed term to the identity
  function to get the same result as the previous manual transformation.
  In general, every term, when converted to CPS, will be have the following properties
  (see O. Danvy, Three Steps for the CPS Transformation, 1991):
  1) The values of all intermediate applications are given a name
  2) The evaluation of these applications is sequentialized based on a traversal of their
     abstract syntax tree.
  3) The results of the transformation are procedures that expect a continuation parameter -
     a lambda abstraction whose application to intermediate values yields the final result
     of the whole evaluation.
  Let us now look at the transformation of a function application. For instance, let us
  consider the term
    f(a)(g(b))
  The transformation of the function argument, f(a), should be
    f_k(a, fval =&gt; ...)
  Similarly, the transformation of the argument position would be:
    g_k(b, aval =&gt; ...)
  Given these two values, fval and aval, we can now perform the application, like so:
    k(fval(aval))
  However, this will not work, because if fval makes a web interaction itself it will not return.
  Instead, k must be given as an argument to the function, like so:
    k =&gt; f_k(a, fval =&gt; g_k(b, aval =&gt; fval(aval,k)))
  Reading this sequentially, it says to evaluate the function expression, store its value in fval,
  then evaluate the argument, store its value in aval, and finally invoke the function on the argument.
  This function's continuation is the same as that of the function application itself.
  What about variables and constants? Since every term in CPS must be a function that consumes a continuation,
  the constant is simply send to the continuation. For instance, the CPS transformation of
  the number 3 is k =&gt; k(3)
  What about function definitions, such as x =&gt; x ? Since every lambda expression is also a constant,
  we might be tempted to use the same rule as above, i.e.,
    k =&gt; k(x =&gt; x)
  However, the transformation is more subtle. A function application invokes the function on two arguments, whereas
  the original function x=&gt;x consumes only one. What is the second argument?
  Answer: It is the _dynamic_ continuation, i.e., the continuation at the time of the function _application_
  (as opposed to its definition). We cannot ignore this continuation: It is the stack active at the point
  of function invocation, so we want to preserve it. This is in contrast to what we did with environments,
  and more in line with our treatment of the store. The transformed version hence reads:
  k =&gt; k( (x,dynk) =&gt; (k =&gt; k(x))(dynk))
  which is equivalent (when the inner application finally happens) to:
  k =&gt; k( (x,dynk) =&gt; dynk(x))
  This is a function that accepts a value and a dynamic continuation and sends the value to that continuation.
  We are now ready to write this transformation formally, as a source-to-source transformation. This transformation
  could have the type cps(e: Exp): Exp, but we choose a different type for two reasons:
  1) In CPS we need function definitions and applications with two arguments instead of one. This could be addressed
     by adding new syntax.
  2) More importantly, we want the invariants of the CPS format to be clearly visible in the syntax definition of the
     result, most importantly the fact that all function applications are tail calls.
  For this reason, we define a special new syntax for CPS-transformed terms. Here is our original syntax: */

sealed abstract class Exp
case class Num(n: Int) extends Exp
case class Id(name: String) extends Exp
case class Add(lhs: Exp, rhs: Exp) extends Exp
case class Fun(param: String, body: Exp) extends Exp
case class Ap (funExpr: Exp, argExpr: Exp) extends Exp
implicit def num2exp(n: Int): Exp = Num(n)
implicit def id2exp(s: String): Exp = Id(s)

/* For CPS transformed terms, we define two different syntactic categories: Values (CPSVal) and Expressions (CPSExp).
   By &quot;values&quot;, we mean terms that &quot;return&quot;, that is, terms that are different from applications of functions
   or continuations (neither of which returns). Additions (CPSAdd) are also values in this regard: We assume addition
   to be built-in and not requiring CPS-transformations.
   The syntax makes clear that all arguments of a function application are values - hence no nesting of applications
   can occur. Furthermore, the syntax differentiates between defining an ordinary function (CPSFun) which, when translated,
   gets an additional continuation parameter, and Continuation Functions (CPSCont), which are the result of the CPS
   transformation. Correspondingly, we have two different forms of applications, CPSContApp and CPSFunApp.
   Here is the formal definition: */
sealed abstract class CPSExp
abstract class CPSVal extends CPSExp
case class CPSNum(n: Int) extends CPSVal
case class CPSCont(v: String, body: CPSExp) extends CPSVal
case class CPSFun(x: String, k: String, body: CPSExp) extends CPSVal
case class CPSVar(x: String) extends CPSVal { override def toString = x.toString }
implicit def id2cpsexp(x: String): CPSVar = CPSVar(x)

case class CPSContAp(k: CPSVal, a: CPSVal) extends CPSExp
case class CPSFunAp(f: CPSVar, a: CPSVar, k: CPSVar) extends CPSExp // the arguments are even CPSVar and not only CPSVal! // the arguments are even CPSVar and not only CPSVal!
case class CPSAdd(l: CPSVar, r: CPSVar) extends CPSVal

/* With these definitions, we are now ready to formalize the transformation described above.
 * There is one technical issues: We need to introduce new names for binders into our program, such as &quot;k&quot;.
 * We need to make sure that we do not accidentially capture existing names in the program. For this
 * reason we need our freshName machinery we introduced in 5-fae.scala.
 */
def freeVars(e: Exp) : Set[String] =  e match {
   case Id(x) =&gt; Set(x)
   case Add(l,r) =&gt; freeVars(l) ++ freeVars(r)
   case Fun(x,body) =&gt; freeVars(body) - x
   case Ap(f,a) =&gt; freeVars(f) ++ freeVars(a)
   case Num(n) =&gt; Set.empty
}
def freshName(names: Set[String], default: String) : String = {
  var last : Int = 0
  var freshName = default
  while (names contains freshName) { freshName = default+last; last += 1; }
  freshName
}

def cps(e: Exp) : CPSCont = e match {
   case Add(e1,e2) =&gt; {
     val k = freshName(freeVars(e), &quot;k&quot;)
     val lv = freshName(freeVars(e2), &quot;lv&quot;)
     CPSCont(k, CPSContAp(cps(e1),CPSCont(lv, CPSContAp(cps(e2), CPSCont(&quot;rv&quot;, CPSContAp(k,CPSAdd(&quot;rv&quot;, lv)))))))
   }
   case Fun(a, body) =&gt; {
     val k = freshName(freeVars(e), &quot;k&quot;)
     val dynk = freshName(freeVars(e), &quot;dynk&quot;)
     CPSCont(k, CPSContAp(k, CPSFun(a, dynk, CPSContAp(cps(body), dynk))))
   }
   case Ap(f,a) =&gt; {
     val k = freshName(freeVars(e), &quot;k&quot;)
     val fval = freshName(freeVars(a), &quot;fval&quot;)
     CPSCont(k, CPSContAp(cps(f), CPSCont(fval, CPSContAp(cps(a), CPSCont(&quot;aval&quot;, CPSFunAp(fval, &quot;aval&quot;, k))))))
   }
   case Id(x) =&gt; {
     val k = freshName(freeVars(e), &quot;k&quot;)
     CPSCont(k, CPSContAp(k, CPSVar(x)))
   }
   case Num(n) =&gt; {
     val k = freshName(freeVars(e), &quot;k&quot;)
     CPSCont(k, CPSContAp(&quot;k&quot;,CPSNum(n)))
   }
}
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../15-continuations-1/continuations-1.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../17-first-class-continuations/first-class-continuations.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../15-continuations-1/continuations-1.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../17-first-class-continuations/first-class-continuations.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../questionnaire.js"></script>
    </body>
</html>
